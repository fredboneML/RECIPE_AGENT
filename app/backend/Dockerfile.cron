FROM python:3.12-slim

# Add curl for health checks and build dependencies
RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    curl \
    gcc \
    libpq-dev \
    procps \
    python3-dev \
    libc-dev \
    make \
    git \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /usr/src/app

# Create necessary directories with proper permissions
RUN mkdir -p /usr/src/app/ai-analyzer/data \
    /usr/src/app/ai-analyzer/prompt_template \
    /var/log \
    && touch /var/log/cron.log \
    && chmod 0666 /var/log/cron.log \
    && chmod -R 777 /usr/src/app/ai-analyzer/data

# Copy the entire backend directory structure
COPY . /usr/src/app/

RUN pip install --upgrade pip
# Modify requirements to use psycopg2-binary instead of psycopg2
RUN sed -i 's/psycopg2==/psycopg2-binary==/g' requirements.txt && \
    pip install --no-cache-dir -r requirements.txt

# Create debug script with correct .env path
RUN echo '#!/bin/bash\n\
    echo "=== $(date) ===" >> /var/log/cron.log\n\
    echo "Directory contents:" >> /var/log/cron.log\n\
    ls -la /usr/src/app/ai-analyzer >> /var/log/cron.log\n\
    echo "Current PYTHONPATH:" >> /var/log/cron.log\n\
    echo $PYTHONPATH >> /var/log/cron.log' > /usr/local/bin/debug.sh \
    && chmod +x /usr/local/bin/debug.sh

# Create the pipeline script
RUN echo '#!/bin/bash\n\
    cd /usr/src/app\n\
    set +x\n\
    # Load environment variables\n\
    eval "$(cat /usr/src/app/.env | sed -e '\''s/[[:space:]]*=[[:space:]]*/=/g'\'' -e '\''s/^/export /'\'')" > /dev/null 2>&1\n\
    export PATH="/usr/local/bin:$PATH"\n\
    export PYTHONPATH=/usr/src/app/ai-analyzer\n\
    export DB_HOST=database\n\
    export PYTHONUNBUFFERED=1\n\
    export PYTHONIOENCODING=UTF-8\n\
    \n\
    # Run debug script\n\
    /usr/local/bin/debug.sh\n\
    \n\
    # Test Qdrant connection\n\
    echo "Testing Qdrant connection..." >> /var/log/cron.log\n\
    python3 -c "from qdrant_client import QdrantClient; client = QdrantClient(host='\''qdrant'\'', port=6333); print(f'\''Qdrant connected: {client.get_collections()}'\'')" >> /var/log/cron.log 2>&1\n\
    \n\
    echo "=== PIPELINE EXECUTION STARTED $(date) ===" >> /var/log/cron.log\n\
    python3 -m ai_analyzer.data_pipeline 2>&1 >> /var/log/cron.log\n\
    echo "=== PIPELINE EXECUTION FINISHED $(date) ===" >> /var/log/cron.log\n\
    sleep 2\n\
    exit 0' > /usr/local/bin/run-pipeline.sh \
    && chmod +x /usr/local/bin/run-pipeline.sh

# Set environment variables
ENV PYTHONPATH=/usr/src/app/ai-analyzer \
    PYTHONUNBUFFERED=1 \
    PYTHONIOENCODING=UTF-8

# This will be the main command that runs the pipeline and exits
CMD ["/usr/local/bin/run-pipeline.sh"]
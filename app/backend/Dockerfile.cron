FROM python:3.12-slim

# Add curl for health checks and cron
RUN apt-get update && apt-get install -y curl cron

WORKDIR /usr/src/app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    gcc \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# Copy the entire ai-analyzer directory and .env file
COPY ai-analyzer /usr/src/app/ai-analyzer/
COPY .env /usr/src/app/.env

# Copy requirements.txt and install dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Create necessary directories (if they don't exist)
RUN mkdir -p /usr/src/app/ai-analyzer/data

# Set permissions for .env file
RUN chmod 644 /usr/src/app/ai-analyzer/.env

# Create the log file and set permissions
RUN touch /var/log/cron.log && \
    chmod 0666 /var/log/cron.log

# Set the correct Python path
ENV PYTHONPATH=/usr/src/app/ai-analyzer

# Debug script to verify paths and environment
RUN echo '#!/bin/bash\n\
echo "=== $(date) ===" >> /var/log/cron.log\n\
echo "Directory contents:" >> /var/log/cron.log\n\
ls -R /usr/src/app >> /var/log/cron.log\n\
echo "Current PYTHONPATH:" >> /var/log/cron.log\n\
echo $PYTHONPATH >> /var/log/cron.log\n\
echo "Environment variables:" >> /var/log/cron.log\n\
env >> /var/log/cron.log\n\
echo ".env file contents:" >> /var/log/cron.log\n\
cat /usr/src/app/ai-analyzer/.env >> /var/log/cron.log' > /debug.sh && \
chmod +x /debug.sh

# Create the cron wrapper script
RUN echo '#!/bin/bash\n\
source /etc/environment\n\
cd /usr/src/app\n\
PYTHONPATH=/usr/src/app/ai-analyzer /usr/local/bin/python3 -m ai_analyzer.data_pipeline' > /usr/local/bin/run-pipeline.sh && \
chmod +x /usr/local/bin/run-pipeline.sh

# Create the cron job
RUN echo "*/5 * * * * /usr/local/bin/run-pipeline.sh >> /var/log/cron.log 2>&1" > /etc/cron.d/pipeline-cron

# Give execution rights on the cron job and apply it
RUN chmod 0644 /etc/cron.d/pipeline-cron && \
    crontab /etc/cron.d/pipeline-cron

# Create startup script
RUN echo '#!/bin/bash\n\
echo "=== Starting container $(date) ===" >> /var/log/cron.log\n\
/debug.sh\n\
export -p | sed "s/declare -x/export/" > /etc/environment\n\
cron -f' > /start.sh && \
chmod +x /start.sh

# Start the cron service
CMD ["/start.sh"]